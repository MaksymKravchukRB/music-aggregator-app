<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Music Hub</title>
  </head>
  <body>
    <audio
      id="audioPlayer"
      controls
      style="display: block; margin-top: 20px"
    ></audio>
    <h1>Unified Music Playback</h1>
    <button onclick="window.location.href='/login'">Login to Spotify</button>

    <h2>Play Spotify Track</h2>
    <button id="togglePlay">Toggle Play</button>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
      window.onSpotifyWebPlaybackSDKReady = () => {
        const token = "[My Spotify Web API access token]";
        const player = new Spotify.Player({
          name: "Web Playback SDK Quick Start Player",
          getOAuthToken: (cb) => {
            cb(token);
          },
        });
      };

      // Ready
      player.addListener("ready", ({ device_id }) => {
        console.log("Ready with Device ID", device_id);
      });

      // Not Ready
      player.addListener("not_ready", ({ device_id }) => {
        console.log("Device ID has gone offline", device_id);
      });

      player.addListener("initialization_error", ({ message }) => {
        console.error(message);
      });

      player.addListener("authentication_error", ({ message }) => {
        console.error(message);
      });

      player.addListener("account_error", ({ message }) => {
        console.error(message);
      });

      document.getElementById("togglePlay").onclick = function () {
        player.togglePlay();
      };

      player.connect();
    </script>

    <input id="spotifyId" placeholder="Spotify Track ID" />
    <button onclick="playSpotify()">Play</button>

    <h2>Play Bandcamp Track</h2>
    <input id="bandcampUrl" placeholder="Bandcamp Track URL" />
    <button onclick="playBandcamp()">Play</button>

    <iframe
      width="100%"
      height="166"
      scrolling="no"
      frameborder="no"
      allow="autoplay"
      src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/295593731&color=%23ff5500&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&visual=true"
    >
    </iframe>

    <iframe
      style="border-radius: 12px"
      src="https://open.spotify.com/embed/track/4bbZcD92nLvQnbrblZTS1K?utm_source=generator"
      width="100%"
      height="352"
      frameborder="0"
      allowfullscreen=""
      allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
      loading="lazy"
    ></iframe>

    <h2>Playback History</h2>
    <ul id="history"></ul>

    <script>
      async function playSpotify() {
        const id = document.getElementById("spotifyId").value;
        await fetch(`/track/spotify/${id}`);
        loadHistory();
      }

      async function playBandcamp() {
        const url = document.getElementById("bandcampUrl").value;
        const res = await fetch(
          `/track/bandcamp?url=${encodeURIComponent(url)}`
        );
        const metadata = await res.json();

        if (metadata.audioUrl) {
          const player = document.getElementById("audioPlayer");
          player.src = metadata.audioUrl;
          player.play();
        }

        loadHistory();
      }

      async function loadHistory() {
        const res = await fetch("/history");
        const data = await res.json();
        const list = document.getElementById("history");
        list.innerHTML = "";
        data.forEach((track) => {
          const li = document.createElement("li");
          li.textContent = `${track.source.toUpperCase()}: ${track.title} by ${
            track.artist
          }`;
          list.appendChild(li);
        });
      }

      async function clearHistory() {
        await fetch("/history", { method: "DELETE" });
        loadHistory();
      }

      loadHistory();
    </script>

    <button onclick="clearHistory()">Clear History</button>
  </body>
</html>
